name: pull-request-main

on:
  merge_group:
  pull_request:
    branches:
      - main

jobs:
  ci-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (needed to reference local action)
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: ci-lint
        uses: ./actions/ci-lint-ts
        with:
          # general inputs
          checkout-repo: "false"
          pnpm-version: "^10.0.0"

  ci-prettier:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (needed to reference local action)
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: ci-prettier
        uses: ./actions/ci-prettier
        with:
          # general inputs
          checkout-repo: "false"
          pnpm-version: "^10.0.0"

  ci-lint-misc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (needed to reference local action)
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: ci-lint-misc
        uses: ./actions/ci-lint-misc
        with:
          # general inputs
          checkout-repo: "false"

  cd-signed-commits:
    # Disable this job until it's updated to be:
    #  1. More generalizable for all workspaces requiring build artifacts
    #  2. Have better attribution for the commits generated from this workflow
    if: false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (needed to reference local action)
        uses: actions/checkout@v5
        with:
          # Commit back any changes based on the commit that triggered this action
          # rather than merge commit of main into the PR branch
          ref: ${{ github.event.pull_request.head.sha }}
          persist-credentials: false

      - name: Setup pnpm
        uses: ./actions/setup-nodejs
        with:
          pnpm-version: "^10.0.0"

      - name: Build signed-commits
        run: pnpm nx run signed-commits:build

      - name: Commit back any changes
        uses: planetscale/ghcommit-action@25309d8005ac7c3bcd61d3fe19b69e0fe47dbdde # v0.2.20
        with:
          commit_message: "ðŸ¤– Update build"
          repo: ${{ github.repository }}
          branch: ${{ github.head_ref || github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ci-signed-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (needed to reference local action)
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Setup pnpm
        uses: ./actions/setup-nodejs
        with:
          pnpm-version: "^10.0.0"

      - name: Run tests for signed-commits
        run: pnpm nx run signed-commits:test

  ci-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (needed to reference local action)
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: ci-test
        uses: ./actions/ci-test-ts
        with:
          # general inputs
          checkout-repo: "false"
          pnpm-version: "^10.0.0"

  ci-build-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (needed to reference local action)
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: ci-build-artifacts
        uses: ./actions/cicd-build-publish-artifacts-ts
        with:
          # general inputs
          checkout-repo: "false"
          pnpm-version: "^10.0.0"

      - name: Check for diff in built artifacts
        run: |
          if [[ $(git status --porcelain "**/index.js") ]]; then
            echo "Built artifacts are out of date. Please run 'pnpm build:artifacts' and commit the changes."
            git status --porcelain "**/index.js"
            exit 1
          else
            echo "Built artifacts are up to date."
          fi
